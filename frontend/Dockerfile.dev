FROM node:20.11-alpine3.19

ENV NODE_ENV=development \
    PORT=3000 \
    NPM_CONFIG_LOGLEVEL=warn \
    PNPM_HOME="/app/.pnpm" \
    PATH="/app/.pnpm:$PATH"

RUN apk add --no-cache \
    curl \
    tini 

WORKDIR /app

RUN npm install -g pnpm@8.15.1 && \
    pnpm config set store-dir .pnpm-store

COPY package*.json pnpm-lock.yaml* ./

RUN pnpm install && \
    pnpm store prune && \
    rm -rf .pnpm-store /root/.cache /root/.npm /root/.pnpm-store

COPY . .

RUN addgroup -S -g 1001 appgroup && \
    adduser -S -u 1001 -G appgroup appuser && \
    chown -R appuser:appgroup /app

USER appuser

HEALTHCHECK --interval=15s --timeout=3s --start-period=15s --retries=3 \
    CMD curl -f http://127.0.0.1:3000/ || exit 1

EXPOSE 3000

ENTRYPOINT ["/sbin/tini", "--"]

CMD ["pnpm", "dev", "--host"]